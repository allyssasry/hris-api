generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "rhel-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"  // Required for PlanetScale (no foreign key constraints)
}

/**
 * ================= ENUMS =================
 */

enum CheckType {
  IN
  OUT
}

enum AttendanceType {
  WFO
  WFH
  VISIT
  ONSITE
}

enum VerifyStatus {
  PENDING
  VALID
  INVALID
}

enum LeaveType {
  ABSENT
  ANNUAL_LEAVE
  SICK_LEAVE
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AdminAttendanceType {
  CLOCK_IN
  CLOCK_OUT
  ABSENT
  ANNUAL_LEAVE
  SICK_LEAVE
}

enum AdminAttendanceStatus {
  ON_TIME
  LATE
}

enum ContractType {
  permanent
  contract
  intern
  resign
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

/**
 * ================= USER =================
 */

model User {
  id       Int     @id @default(autoincrement())
  email    String? @unique
  username String? @unique
  password String

  firstName String?
  lastName  String?
  
  // Profile fields (untuk admin dan user yang tidak punya employee record)
  phone       String?   @db.VarChar(50)
  nik         String?   @db.VarChar(50)
  gender      String?   @db.VarChar(10)
  birthDate   DateTime?
  birthPlace  String?   @db.VarChar(100)
  education   String?   @db.VarChar(50)
  bank        String?   @db.VarChar(50)
  accountName String?   @db.VarChar(100)
  accountNumber String? @db.VarChar(100)
  avatar      String?
  position    String?   @db.VarChar(100) // CEO, Manager, Staff, dll

  role String @default("user") // user | admin

  // ===== RELASI COMPANY (ANGGOTA) =====
  companyId Int?
  company   Company? @relation("CompanyUsers", fields: [companyId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ===== RELASI COMPANY (OWNER) =====
  ownedCompanies Company[] @relation("CompanyOwner")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employees       Employee[]
  salaries        Salary[]
  accounts        OAuthAccount[]
  assignments     CheckAssignment[] @relation("AssignmentOwner")
  approvedLetters Letter[]          @relation("LetterApprover")
  letters         Letter[]          @relation("LetterOwner")
  userShifts      UserShift[]
  leaves          Leave[]
  
  // Notifications
  notifications     Notification[] @relation("NotificationRecipient")
  sentNotifications Notification[] @relation("NotificationSender")

  resetPasswordToken String?
  resetPasswordExp   DateTime?
}

model Company {
  id   Int    @id @default(autoincrement())
  name String

  // ===== OWNER COMPANY =====
  ownerId Int
  owner   User @relation("CompanyOwner", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ===== SEMUA USER DALAM COMPANY =====
  users User[] @relation("CompanyUsers")

  // ===== EMPLOYEE =====
  employees Employee[]

  // ===== LOKASI KANTOR =====
  locations CompanyLocation[]

  // ===== NOTIFICATIONS =====
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * ================= COMPANY LOCATION =================
 * Lokasi kantor yang bisa dipilih saat checkclock
 */
model CompanyLocation {
  id        Int     @id @default(autoincrement())
  name      String  @db.VarChar(100) // "Kantor Pusat", "Kantor Jakarta", dll
  address   String? @db.VarChar(255) // Alamat lengkap (opsional)
  latitude  Float
  longitude Float
  isActive  Boolean @default(true)

  // ===== RELASI COMPANY =====
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

/**
 * ================= EMPLOYEE =================
 */

model Employee {
  id            Int       @id @default(autoincrement())
  employeeId String // Unique per company, not globally
  firstName     String
  lastName      String?
  phone         String?   @db.VarChar(50)
  nik           String?   @db.VarChar(50)
  gender        String?   @db.VarChar(10)
  birthDate     DateTime?
  jobdesk       String?   @db.VarChar(100)
  branch        String?   @db.VarChar(100)
  contractType  String?   @db.VarChar(50)
  grade         String?   @db.VarChar(50)
  bank          String?   @db.VarChar(50)
  accountName   String?   @db.VarChar(100)
  accountNumber String?   @db.VarChar(100)
  spType        String?   @db.VarChar(20)
  education     String? // ⭐ Pendidikan terakhir
  avatar        String?

  // ===== STATUS KEAKTIFAN =====
  isActive        Boolean   @default(true)  // false = nonaktifkan sementara
  terminationType String?   @db.VarChar(20) // resign | terminated (PHK)
  terminatedAt    DateTime?                 // tanggal resign/terminated

  // ===== RELASI COMPANY =====
  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  // ===== RELASI USER =====
  userId Int?
  User   User? @relation(fields: [userId], references: [id])

  // ===== RELASI LAIN =====
  EmployeeCredential EmployeeCredential[]
  checkClocks        CheckClock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ===== COMPOSITE UNIQUE (employeeId per company) =====
  @@unique([employeeId, companyId], name: "Employee_employeeId_companyId")
}

/**
 * ================= EMPLOYEE CREDENTIAL =================
 */

model EmployeeCredential {
  id          Int     @id @default(autoincrement())
  employeeId  Int
  companyUser String  @db.VarChar(100)
  empCode     String  @db.VarChar(100)
  password    String
  isActive    Boolean @default(true)

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([companyUser, empCode], name: "companyUser_empCode")
}

/**
 * ================= OAUTH =================
 */

model OAuthAccount {
  id                Int     @id @default(autoincrement())
  userId            Int
  provider          String  @db.VarChar(50)
  providerAccountId String  @db.VarChar(191)
  email             String? @db.VarChar(191)
  accessToken       String? @db.Text
  refreshToken      String? @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId], name: "provider_providerAccountId")
}

/**
 * ================= SALARY =================
 */

model Salary {
  id          Int       @id @default(autoincrement())
  userId      Int
  type        String    @db.VarChar(50)
  amount      Decimal   @db.Decimal(12, 2)
  note        String?   @db.Text
  periodStart DateTime?
  periodEnd   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/**
 * ================= CHECK CLOCK SETTINGS =================
 */

model CheckClockSetting {
  id        Int       @id @default(autoincrement())
  name      String
  type      String    @db.VarChar(50)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  times      CheckClockSettingTime[]
  userShifts UserShift[]
}

model CheckClockSettingTime {
  id                  Int       @id @default(autoincrement())
  checkClockSettingId Int
  day                 Int
  clockInMinutes      Int?
  breakStartMinutes   Int?
  breakEndMinutes     Int?
  clockOutMinutes     Int?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  deletedAt           DateTime?

  setting CheckClockSetting @relation(fields: [checkClockSettingId], references: [id], onDelete: Cascade)

  @@index([checkClockSettingId, day])
}

model CheckClock {
  id           Int       @id @default(autoincrement())
  employeeId   Int
  type         String
  clockOutTime DateTime? // ⬅️ WAJIB
  time         DateTime?   // ✅ UBAH INI

  status     String? // ON_TIME / LATE (SUDAH ADA)
  approval   ApprovalStatus @default(PENDING) // ⬅️ TAMBAHAN
  approvedBy Int? // admin user id
  approvedAt DateTime?

  locationName String
  address      String?
  latitude     Float?
  longitude    Float?
  notes        String?
  
  // Clock In proof
  proofPath    String?
  proofName    String?
  
  // Clock Out proof (NEW)
  clockOutProofPath String?
  clockOutProofName String?

  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("checkclock")
}

/**
 * ================= USER SHIFT =================
 */

model UserShift {
  id                  Int       @id @default(autoincrement())
  userId              Int
  checkClockSettingId Int
  effectiveFrom       DateTime
  effectiveTo         DateTime?

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  setting CheckClockSetting @relation(fields: [checkClockSettingId], references: [id], onDelete: Cascade)

  @@index([userId, effectiveFrom])
}

/**
 * ================= CHECK CLOCK =================
 */

model CheckAssignment {
  id             Int            @id @default(autoincrement())
  userId         Int
  attendanceType AttendanceType
  latitude       Decimal?       @db.Decimal(10, 7)
  longitude      Decimal?       @db.Decimal(10, 7)
  address        String?
  locationName   String?
  geoRadius      Int?
  startAt        DateTime?
  endAt          DateTime?
  note           String?        @db.Text
  createdBy      Int?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?

  owner User @relation("AssignmentOwner", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startAt, endAt])
}

/**
 * ================= LEAVE =================
 */

model Leave {
  id         Int         @id @default(autoincrement())
  userId     Int
  type       LeaveType
  note       String?     @db.Text
  startDate  DateTime
  endDate    DateTime
  attachment String?     @db.VarChar(191)
  status     LeaveStatus @default(PENDING)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  deletedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startDate, endDate])
}

/**
 * ================= LETTER =================
 */

model LetterFormat {
  id        Int       @id @default(autoincrement())
  name      String
  content   String    @db.Text
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  letters Letter[]
}

model Letter {
  id             Int       @id @default(autoincrement())
  letterFormatId Int
  userId         Int
  name           String
  number         String?   @unique
  status         String    @default("draft")
  payload        Json?
  fileUrl        String?   @db.VarChar(191)
  approverId     Int?
  approvedAt     DateTime?
  rejectedReason String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  format   LetterFormat @relation(fields: [letterFormatId], references: [id], onDelete: Restrict)
  owner    User         @relation("LetterOwner", fields: [userId], references: [id], onDelete: Cascade)
  approver User?        @relation("LetterApprover", fields: [approverId], references: [id], onDelete: SetNull)
}

/**
 * ================= NOTIFICATION =================
 */

model Notification {
  id          Int       @id @default(autoincrement())
  userId      Int       // Recipient user ID
  fromUserId  Int?      // Sender user ID (null for system notifications)
  companyId   Int?      // Company ID for multi-tenancy filtering
  type        String    // CHECKCLOCK_APPROVED, CHECKCLOCK_REJECTED, CHECKCLOCK_SUBMITTED, etc.
  title       String
  message     String    @db.Text
  data        Json?     // Additional data (e.g., checkclockId, employeeId)
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())

  user     User     @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  fromUser User?    @relation("NotificationSender", fields: [fromUserId], references: [id], onDelete: SetNull)
  company  Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([companyId])
}
